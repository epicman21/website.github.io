<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shrine Canvas — Offline Block Builder</title>
  <style>
    :root {
      --bg: #0b0e12;
      --panel: #10151c;
      --ink: #e6edf3;
      --muted: #93a1b3;
      --accent: #7aa2ff;
      --grid: 1; /* 1=on, 0=off */
      --cell: 24px;
      --gap: 1px;
    }
    * { box-sizing: border-box; }
    html, body {
      height: 100%;
      background: radial-gradient(1000px 500px at 10% 0%, #0f1520 0%, #0b0e12 60%) no-repeat, var(--bg);
      color: var(--ink);
      margin: 0;
      font: 14px/1.35 ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
    }
    .wrap {
      max-width: 980px;
      margin: 32px auto;
      padding: 0 16px 32px;
    }
    header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 16px;
    }
    h1 {
      margin: 0;
      font-size: 20px;
      letter-spacing: .3px;
    }
    .hint { color: var(--muted); font-size: 12px; }
    .panel {
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(0,0,0,.08));
      border: 1px solid rgba(255,255,255,.06);
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.05);
      padding: 12px;
    }
    .toolbar {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      margin-bottom: 12px;
    }
    .palette {
      display: flex; flex-wrap: wrap; gap: 8px;
      align-items: center;
    }
    .swatch {
      width: 24px; height: 24px; border-radius: 6px; cursor: pointer;
      border: 1px solid rgba(255,255,255,.15);
      box-shadow: 0 1px 0 rgba(255,255,255,.08) inset, 0 1px 4px rgba(0,0,0,.35);
      position: relative;
    }
    .swatch[data-active="1"]::after {
      content: ""; position: absolute; inset: -3px;
      border: 2px solid var(--accent); border-radius: 8px; pointer-events: none;
    }
    .controls { display: flex; gap: 8px; flex-wrap: wrap; }
    button, .toggle {
      background: #0e1420;
      color: var(--ink);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 10px;
      padding: 8px 10px;
      cursor: pointer;
      box-shadow: 0 1px 0 rgba(255,255,255,.06) inset, 0 4px 14px rgba(0,0,0,.25);
      transition: transform .02s ease, background .2s ease, border-color .2s ease;
    }
    button:hover, .toggle:hover { background: #121a2a; border-color: rgba(255,255,255,.2); }
    button:active, .toggle:active { transform: translateY(1px); }
    .toggle { display: inline-flex; align-items: center; gap: 8px; }
    .grid {
      --cols: 16;
      display: grid;
      grid-template-columns: repeat(var(--cols), var(--cell));
      grid-auto-rows: var(--cell);
      gap: var(--gap);
      width: max-content;
      margin: 0 auto;
      user-select: none;
      border-radius: 12px;
      padding: 8px;
      background: #0b111a;
      border: 1px solid rgba(255,255,255,.06);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.04), 0 10px 30px rgba(0,0,0,.35);
    }
    .cell {
      width: var(--cell); height: var(--cell);
      background: transparent;
      border: 1px solid rgba(255,255,255, calc(.06*var(--grid)));
      border-radius: 4px;
      box-shadow: 0 0 0 1px rgba(0,0,0,.35) inset;
      cursor: crosshair;
      transition: filter .05s ease;
    }
    .cell:hover { filter: brightness(1.15); }
    .footer {
      display: flex; justify-content: space-between; align-items: center; margin-top: 12px; color: var(--muted);
      gap: 12px; flex-wrap: wrap;
    }
    .kbd { font: 600 12px/1 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; background: #0f1625; border: 1px solid rgba(255,255,255,.14); padding: 2px 6px; border-radius: 6px; color: #cfe0ff; }
    /* Modal */
    .modal {
      position: fixed; inset: 0; display: none; place-items: center; background: rgba(0,0,0,.5); padding: 16px;
    }
    .modal[open] { display: grid; }
    .sheet {
      width: min(720px, 100%); background: var(--panel); border: 1px solid rgba(255,255,255,.1); border-radius: 12px; padding: 16px; box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    .sheet h2 { margin: 0 0 8px; font-size: 16px; }
    textarea {
      width: 100%; height: 160px; resize: vertical; background: #0e1420; color: var(--ink);
      border: 1px solid rgba(255,255,255,.14); border-radius: 10px; padding: 10px;
      font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
    }
    .row { display: flex; gap: 8px; justify-content: flex-end; margin-top: 10px; flex-wrap: wrap; }
    .badge { color: #c2d3ff; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace; }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Shrine Canvas — Offline Block Builder</h1>
      <div class="hint">No installs, no cloud, no trackers. Works offline.</div>
    </header>

    <div class="panel">
      <div class="toolbar">
        <div class="palette" id="palette" title="Pick a color (keys 1–9, 0)">
          <!-- swatches injected by JS -->
        </div>
        <div class="controls">
          <button id="clearBtn" title="Clear the canvas (C)">Clear</button>
          <button id="exportBtn" title="Export a compact string (E)">Export</button>
          <button id="importBtn" title="Import from a string (I)">Import</button>
          <button id="randomBtn" title="Sprinkle current color randomly (R)">Randomize</button>
          <label class="toggle" title="Toggle grid lines (G)">
            <input type="checkbox" id="gridToggle" />
            <span>Grid</span>
          </label>
        </div>
      </div>

      <div class="grid" id="grid" aria-label="Pixel grid" role="application">
        <!-- cells injected by JS -->
      </div>

      <div class="footer">
        <div>
          <span class="kbd">Drag</span> to paint • <span class="kbd">Right-click</span> to erase •
          <span class="kbd">1–9,0</span> colors • <span class="kbd">C</span> clear • <span class="kbd">E</span> export • <span class="kbd">I</span> import • <span class="kbd">G</span> grid • <span class="kbd">R</span> random
        </div>
        <div class="badge">Autosaved locally</div>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div class="modal" id="modal" aria-hidden="true">
    <div class="sheet">
      <h2 id="modalTitle">Export</h2>
      <textarea id="modalText" spellcheck="false"></textarea>
      <div class="row">
        <button id="copyBtn" title="Copy to clipboard">Copy</button>
        <button id="closeBtn" title="Close">Close</button>
      </div>
    </div>
  </div>

  <script>
    (() => {
      // Config
      const SIZE = 16;                 // 16x16 grid
      const KEY = "shrineCanvas16.v1"; // localStorage key
      const EMPTY = 0;                 // index 0 = empty/transparent

      // 16-color palette (hex). Index corresponds to hex digit 0–F.
      const PALETTE = [
        "transparent", // 0 (empty)
        "#ffffff",     // 1 white
        "#000000",     // 2 black
        "#ff3b30",     // 3 red
        "#ff9500",     // 4 orange
        "#ffd60a",     // 5 yellow
        "#34c759",     // 6 green
        "#30d0ff",     // 7 cyan
        "#0a84ff",     // 8 blue
        "#7a79ff",     // 9 indigo
        "#bf5af2",     // A violet
        "#ff2d55",     // B rose
        "#8e8e93",     // C gray
        "#5ac8fa",     // D sky
        "#64d2ff",     // E ice
        "#ffcc00"      // F gold
      ];

      // DOM
      const gridEl = document.getElementById("grid");
      const paletteEl = document.getElementById("palette");
      const clearBtn = document.getElementById("clearBtn");
      const exportBtn = document.getElementById("exportBtn");
      const importBtn = document.getElementById("importBtn");
      const randomBtn = document.getElementById("randomBtn");
      const gridToggle = document.getElementById("gridToggle");
      const modal = document.getElementById("modal");
      const modalTitle = document.getElementById("modalTitle");
      const modalText = document.getElementById("modalText");
      const copyBtn = document.getElementById("copyBtn");
      const closeBtn = document.getElementById("closeBtn");

      // State
      let data = new Array(SIZE * SIZE).fill(EMPTY);
      let current = 8; // default to blue-ish
      let drawing = false;
      let eraseMode = false;

      // Init
      gridEl.style.setProperty("--cols", SIZE);
      buildPalette();
      buildGrid();
      load();
      updateActiveSwatch();
      gridToggle.checked = true; // grid on by default

      // Build palette
      function buildPalette() {
        paletteEl.innerHTML = "";
        for (let i = 0; i < PALETTE.length; i++) {
          const sw = document.createElement("button");
          sw.className = "swatch";
          sw.style.background = PALETTE[i];
          sw.title = i.toString(16).toUpperCase();
          sw.dataset.index = i;
          sw.addEventListener("click", () => {
            current = i;
            updateActiveSwatch();
          });
          paletteEl.appendChild(sw);
        }
      }
      function updateActiveSwatch() {
        for (const el of paletteEl.children) el.dataset.active = "0";
        const active = paletteEl.children[current];
        if (active) active.dataset.active = "1";
      }

      // Build grid
      function buildGrid() {
        gridEl.innerHTML = "";
        gridEl.addEventListener("contextmenu", e => e.preventDefault());
        for (let i = 0; i < data.length; i++) {
          const cell = document.createElement("div");
          cell.className = "cell";
          cell.dataset.i = i;
          paintCellEl(cell, data[i]);
          cell.addEventListener("mousedown", onDown);
          cell.addEventListener("mouseenter", onEnter);
          cell.addEventListener("mouseup", onUp);
          gridEl.appendChild(cell);
        }
        window.addEventListener("mouseup", () => { drawing = false; });
      }

      function onDown(e) {
        const i = +this.dataset.i;
        drawing = true;
        eraseMode = (e.button === 2) || (current === EMPTY);
        const idx = eraseMode ? EMPTY : current;
        setAt(i, idx, true);
      }
      function onEnter() {
        if (!drawing) return;
        const i = +this.dataset.i;
        const idx = eraseMode ? EMPTY : current;
        setAt(i, idx, true);
      }
      function onUp() { drawing = false; }

      // Data ops
      function setAt(i, idx, repaint = false) {
        data[i] = idx;
        if (repaint) paintCellEl(gridEl.children[i], idx);
        saveThrottled();
      }
      function paintCellEl(el, idx) {
        el.style.background = PALETTE[idx];
      }

      // Persistence
      let saveTimer = null;
      function saveThrottled() {
        if (saveTimer) return;
        saveTimer = setTimeout(() => {
          saveTimer = null;
          save();
        }, 150);
      }
      function save() {
        try {
          const payload = {
            size: SIZE,
            scheme: "hex16",
            content: encode(data)
          };
          localStorage.setItem(KEY, JSON.stringify(payload));
        } catch {}
      }
      function load() {
        try {
          const raw = localStorage.getItem(KEY);
          if (!raw) return;
          const payload = JSON.parse(raw);
          if (payload.size !== SIZE || payload.scheme !== "hex16") return;
          const arr = decode(payload.content);
          if (arr && arr.length === data.length) {
            data = arr;
            // repaint
            for (let i = 0; i < data.length; i++) {
              paintCellEl(gridEl.children[i], data[i]);
            }
          }
        } catch {}
      }

      // Encode: 256 hex digits (0–F)
      function encode(arr) {
        let out = "";
        for (let i = 0; i < arr.length; i++) {
          out += arr[i].toString(16);
        }
        return out;
      }
      function decode(str) {
        const s = (str || "").trim().toLowerCase();
        if (!/^[0-9a-f]+$/.test(s)) return null;
        if (s.length !== SIZE * SIZE) return null;
        const out = new Array(s.length);
        for (let i = 0; i < s.length; i++) {
          out[i] = parseInt(s[i], 16);
        }
        return out;
      }

      // Buttons
      clearBtn.addEventListener("click", () => {
        if (!confirm("Clear the canvas?")) return;
        data.fill(EMPTY);
        for (let i = 0; i < data.length; i++) paintCellEl(gridEl.children[i], EMPTY);
        save();
      });
      exportBtn.addEventListener("click", () => {
        modalTitle.textContent = "Export — Share this string";
        modalText.value = encode(data);
        openModal();
        modalText.select();
      });
      importBtn.addEventListener("click", () => {
        modalTitle.textContent = "Import — Paste string below";
        modalText.value = "";
        openModal();
        modalText.focus();
      });
      randomBtn.addEventListener("click", () => {
        const chance = 0.12; // 12% fill
        for (let i = 0; i < data.length; i++) {
          const v = Math.random() < chance ? current : EMPTY;
          data[i] = v;
          paintCellEl(gridEl.children[i], v);
        }
        save();
      });
      gridToggle.addEventListener("change", () => {
        const on = gridToggle.checked ? 1 : 0;
        document.documentElement.style.setProperty("--grid", on);
      });

      // Modal
      function openModal() {
        modal.setAttribute("open", "");
        modal.setAttribute("aria-hidden", "false");
      }
      function closeModal() {
        modal.removeAttribute("open");
        modal.setAttribute("aria-hidden", "true");
      }
      copyBtn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(modalText.value);
          copyBtn.textContent = "Copied";
          setTimeout(() => (copyBtn.textContent = "Copy"), 1000);
        } catch {
          modalText.select();
          alert("Select the text and press Ctrl+C to copy.");
        }
      });
      closeBtn.addEventListener("click", () => {
        if (modalTitle.textContent.startsWith("Import")) {
          const arr = decode(modalText.value);
          if (!arr) {
            closeModal();
            return alert("Invalid string. Expecting " + (SIZE * SIZE) + " hex digits.");
          }
          data = arr;
          for (let i = 0; i < data.length; i++) paintCellEl(gridEl.children[i], data[i]);
          save();
        }
        closeModal();
      });
      modal.addEventListener("click", (e) => {
        if (e.target === modal) closeBtn.click();
      });

      // Keyboard shortcuts
      window.addEventListener("keydown", (e) => {
        if (e.target.matches("textarea, input")) return;
        const k = e.key.toLowerCase();
        if (k === "c") { clearBtn.click(); e.preventDefault(); }
        else if (k === "e") { exportBtn.click(); e.preventDefault(); }
        else if (k === "i") { importBtn.click(); e.preventDefault(); }
        else if (k === "g") { gridToggle.click(); e.preventDefault(); }
        else if (k === "r") { randomBtn.click(); e.preventDefault(); }
        else if ("1234567890".includes(e.key)) {
          // 1..9 map to 1..9, 0 maps to 10 (A)
          const map = { "0": 10 };
          const idx = map[e.key] ?? parseInt(e.key, 10);
          if (idx >= 0 && idx < PALETTE.length) {
            current = idx;
            updateActiveSwatch();
          }
        }
      });

      // Accessibility: focus outline on keyboard use
      let usingMouse = false;
      window.addEventListener("mousedown", () => (usingMouse = true));
      window.addEventListener("keydown", () => (usingMouse = false));
      document.body.addEventListener("focusin", (e) => {
        if (usingMouse) e.target.style.outline = "none";
        else e.target.style.outline = "2px solid var(--accent)";
      });
      document.body.addEventListener("focusout", (e) => (e.target.style.outline = "none"));
    })();
  </script>
</body>
</html>
